!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("koishi-adapter-onebot"),require("koishi-plugin-puppeteer"),require("koishi-core"),require("dayjs"),require("querystring"),require("koishi"),require("react-dom/server"),require("react"),require("path"),require("node-sass"),require("marked"),require("highlight.js"),require("html-entities"),require("util"),require("stream"),require("zlib"),require("assert"),require("buffer"),require("crypto")):"function"==typeof define&&define.amd?define(["exports","koishi-adapter-onebot","koishi-plugin-puppeteer","koishi-core","dayjs","querystring","koishi","react-dom/server","react","path","node-sass","marked","highlight.js","html-entities","util","stream","zlib","assert","buffer","crypto"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["koishi-plugin-work"]={},null,null,t.koishiCore,t.dayjs,t.querystring,t.koishi,t.server,t.React,t.path,t.sass,t.marked,t.hljs,t.htmlEntities,t.util,t.stream,t.zlib,t.assert,t.buffer,t.crypto)}(this,(function(t,e,r,n,i,s,o,a,h,l,u,c,f,p,d,_,g,m,y,b){"use strict";function w(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function E(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var v=w(i),k=E(s),T=E(h),O=w(l),x=w(u),R=w(c),C=w(f),P=w(d),I=w(_),L=w(g),A=w(m),D=w(y),S=w(b);function Y(t,e,r,n,i,s,o){try{var a=t[s](o),h=a.value}catch(t){return void r(t)}a.done?e(h):Promise.resolve(h).then(n,i)}function M(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var s=t.apply(e,r);function o(t){Y(s,n,i,o,a,"next",t)}function a(t){Y(s,n,i,o,a,"throw",t)}o(void 0)}))}}function B(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function N(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function U(t,e,r){return e&&N(t.prototype,e),r&&N(t,r),t}function q(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function H(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function j(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?H(Object(r),!0).forEach((function(e){q(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):H(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function G(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=t&&("undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"]);if(null==r)return;var n,i,s=[],o=!0,a=!1;try{for(r=r.call(t);!(o=(n=r.next()).done)&&(s.push(n.value),!e||s.length!==e);o=!0);}catch(t){a=!0,i=t}finally{try{o||null==r.return||r.return()}finally{if(a)throw i}}return s}(t,e)||z(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function F(t){return function(t){if(Array.isArray(t))return $(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||z(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function z(t,e){if(t){if("string"==typeof t)return $(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?$(t,e):void 0}}function $(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}const V=new Uint8Array(256);let W=V.length;function Z(){return W>V.length-16&&(S.default.randomFillSync(V),W=0),V.slice(W,W+=16)}var K=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const X=[];for(let t=0;t<256;++t)X.push((t+256).toString(16).substr(1));function J(t,e=0){const r=(X[t[e+0]]+X[t[e+1]]+X[t[e+2]]+X[t[e+3]]+"-"+X[t[e+4]]+X[t[e+5]]+"-"+X[t[e+6]]+X[t[e+7]]+"-"+X[t[e+8]]+X[t[e+9]]+"-"+X[t[e+10]]+X[t[e+11]]+X[t[e+12]]+X[t[e+13]]+X[t[e+14]]+X[t[e+15]]).toLowerCase();if(!function(t){return"string"==typeof t&&K.test(t)}(r))throw TypeError("Stringified UUID is invalid");return r}function Q(t,e,r){const n=(t=t||{}).random||(t.rng||Z)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){r=r||0;for(let t=0;t<16;++t)e[r+t]=n[t];return e}return J(n)}var tt=new(function(){function t(){B(this,t)}return U(t,[{key:"at",value:function(t){return o.segment("at",{id:t})}},{key:"atMe",value:function(t){var e,r;return o.segment("at",{id:null!==(e=null==t||null===(r=t.author)||void 0===r?void 0:r.userId)&&void 0!==e?e:""})}},{key:"img",value:function(t){return o.segment("image",{url:t})}}]),t}()),et=function(t,e){return M(regeneratorRuntime.mark((function r(){var n,i,s,o,a;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=e.split(":"),i=G(n,2),s=i[0],o=i[1],r.next=4,t.database.getUser(s,o);case 4:if(void 0!==(a=r.sent)){r.next=11;break}return r.next=8,t.database.createUser(s,o,{todos:[]});case 8:return r.next=10,t.database.getUser(s,o);case 10:a=r.sent;case 11:return r.abrupt("return",a);case 12:case"end":return r.stop()}}),r)})))()},rt=new(function(){function t(){B(this,t),this.styles={},this.defaultStyles={}}return U(t,[{key:"pushStyle",value:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];return this.styles[t]=r,this}},{key:"renderStyles",value:function(){var t="",e=j(j({},this.styles),this.defaultStyles);for(var r in e)t+="<style>".concat(x.default.renderSync({file:O.default.resolve.apply(O.default,F(e[r]))}).css.toString(),"</style>");return t}},{key:"clearStyle",value:function(){return this.styles={},this}}]),t}());R.default.setOptions({highlight:(t,e,r)=>""!==e?C.default.highlight(t,{language:e}).value:C.default.highlightAuto(t).value,pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});const nt=({todo:t})=>(rt.pushStyle("github-highlight",process.cwd(),"./node_modules/highlight.js/scss/nord.scss"),rt.pushStyle("todo-card",__dirname,"./todo-card.module.scss"),T.createElement("div",{className:"todo-card"},T.createElement("h2",{className:"title"},T.createElement("span",{className:"status"},"processing"===t.status?"â":"âœ…"),T.createElement("span",{className:"el-tag el-tag--success"},t.id)),T.createElement("h2",{className:"title"},t.name),t.tags.length>0&&T.createElement("h3",null,t.tags.map(((t,e)=>T.createElement("span",{key:e,className:"el-tag"},t)))),T.createElement("h3",null,"ä»‹ç»"),T.createElement("div",{className:"desc markdown-body",dangerouslySetInnerHTML:{__html:R.default(p.decode(t?.desc??"æœªæè¿°å†…å®¹"))}}),T.createElement("div",{className:"designator"},T.createElement("h3",null,"æŒ‡æ´¾äºº"),T.createElement("span",{className:"content"},t.designator?.qq?T.createElement("img",{className:"avatar",src:`http://q.qlogo.cn/headimg_dl?dst_uin=${t.designator?.qq}&spec=640`,alt:""}):"",T.createElement("span",{className:"el-tag"},t.designator?.qq??"æ— æŒ‡æ´¾äºº"))),T.createElement("div",{className:"datetime"},v.default(t.ctime).format("YYYY-MM-DD HH:mm:ss")))),it=({todos:t})=>{rt.pushStyle("static-todos",__dirname,"./static-todos.module.scss");const e=t.length,r=(n="finished",t.filter((t=>t.status===n)));var n;return T.createElement("div",{className:"staticTodosTemplate"},T.createElement("h1",null,"å…±",e,"ğŸ“"),T.createElement("h2",null,T.createElement("label",null,"å½“å‰è¿›åº¦ ",r.length," / ",e),T.createElement("div",{className:"bar"},T.createElement("div",{className:"cur-process",style:{width:r.length/e*100+"%"}}))),t.map((t=>T.createElement(nt,{key:t.id,todo:t}))))};
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */
function st(t,e,r,n){var i,s=arguments.length,o=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o}function ot(t,e){return t(e={exports:{}},e.exports),e.exports}var at=ot((function(t){let e=t.exports=function(){I.default.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};P.default.inherits(e,I.default),e.prototype.read=function(t,e){this._reads.push({length:Math.abs(t),allowLess:t<0,func:e}),process.nextTick(function(){this._process(),this._paused&&this._reads&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))},e.prototype.write=function(t,e){if(!this.writable)return this.emit("error",new Error("Stream not writable")),!1;let r;return r=Buffer.isBuffer(t)?t:Buffer.from(t,e||this._encoding),this._buffers.push(r),this._buffered+=r.length,this._process(),this._reads&&0===this._reads.length&&(this._paused=!0),this.writable&&!this._paused},e.prototype.end=function(t,e){t&&this.write(t,e),this.writable=!1,this._buffers&&(0===this._buffers.length?this._end():(this._buffers.push(null),this._process()))},e.prototype.destroySoon=e.prototype.end,e.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()},e.prototype.destroy=function(){this._buffers&&(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))},e.prototype._processReadAllowingLess=function(t){this._reads.shift();let e=this._buffers[0];e.length>t.length?(this._buffered-=t.length,this._buffers[0]=e.slice(t.length),t.func.call(this,e.slice(0,t.length))):(this._buffered-=e.length,this._buffers.shift(),t.func.call(this,e))},e.prototype._processRead=function(t){this._reads.shift();let e=0,r=0,n=Buffer.alloc(t.length);for(;e<t.length;){let i=this._buffers[r++],s=Math.min(i.length,t.length-e);i.copy(n,e,0,s),e+=s,s!==i.length&&(this._buffers[--r]=i.slice(s))}r>0&&this._buffers.splice(0,r),this._buffered-=t.length,t.func.call(this,n)},e.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){let t=this._reads[0];if(t.allowLess)this._processReadAllowingLess(t);else{if(!(this._buffered>=t.length))break;this._processRead(t)}}this._buffers&&!this.writable&&this._end()}catch(t){this.emit("error",t)}}}));let ht=[{x:[0],y:[0]},{x:[4],y:[0]},{x:[0,4],y:[4]},{x:[2,6],y:[0,4]},{x:[0,2,4,6],y:[2,6]},{x:[1,3,5,7],y:[0,2,4,6]},{x:[0,1,2,3,4,5,6,7],y:[1,3,5,7]}];var lt=function(t,e){let r=[],n=t%8,i=e%8,s=(t-n)/8,o=(e-i)/8;for(let t=0;t<ht.length;t++){let e=ht[t],a=s*e.x.length,h=o*e.y.length;for(let t=0;t<e.x.length&&e.x[t]<n;t++)a++;for(let t=0;t<e.y.length&&e.y[t]<i;t++)h++;a>0&&h>0&&r.push({width:a,height:h,index:t})}return r},ut=function(t){return function(e,r,n){let i=e%ht[n].x.length,s=(e-i)/ht[n].x.length*8+ht[n].x[i],o=r%ht[n].y.length;return 4*s+((r-o)/ht[n].y.length*8+ht[n].y[o])*t*4}},ct=function(t,e,r){let n=t+e-r,i=Math.abs(n-t),s=Math.abs(n-e),o=Math.abs(n-r);return i<=s&&i<=o?t:s<=o?e:r},ft=ot((function(t){function e(t,e,r){let n=t*e;return 8!==r&&(n=Math.ceil(n/(8/r))),n}let r=t.exports=function(t,r){let n=t.width,i=t.height,s=t.interlace,o=t.bpp,a=t.depth;if(this.read=r.read,this.write=r.write,this.complete=r.complete,this._imageIndex=0,this._images=[],s){let t=lt(n,i);for(let r=0;r<t.length;r++)this._images.push({byteWidth:e(t[r].width,o,a),height:t[r].height,lineIndex:0})}else this._images.push({byteWidth:e(n,o,a),height:i,lineIndex:0});this._xComparison=8===a?o:16===a?2*o:1};r.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))},r.prototype._unFilterType1=function(t,e,r){let n=this._xComparison,i=n-1;for(let s=0;s<r;s++){let r=t[1+s],o=s>i?e[s-n]:0;e[s]=r+o}},r.prototype._unFilterType2=function(t,e,r){let n=this._lastLine;for(let i=0;i<r;i++){let r=t[1+i],s=n?n[i]:0;e[i]=r+s}},r.prototype._unFilterType3=function(t,e,r){let n=this._xComparison,i=n-1,s=this._lastLine;for(let o=0;o<r;o++){let r=t[1+o],a=s?s[o]:0,h=o>i?e[o-n]:0,l=Math.floor((h+a)/2);e[o]=r+l}},r.prototype._unFilterType4=function(t,e,r){let n=this._xComparison,i=n-1,s=this._lastLine;for(let o=0;o<r;o++){let r=t[1+o],a=s?s[o]:0,h=o>i?e[o-n]:0,l=o>i&&s?s[o-n]:0,u=ct(h,a,l);e[o]=r+u}},r.prototype._reverseFilterLine=function(t){let e,r=t[0],n=this._images[this._imageIndex],i=n.byteWidth;if(0===r)e=t.slice(1,i+1);else switch(e=Buffer.alloc(i),r){case 1:this._unFilterType1(t,e,i);break;case 2:this._unFilterType2(t,e,i);break;case 3:this._unFilterType3(t,e,i);break;case 4:this._unFilterType4(t,e,i);break;default:throw new Error("Unrecognised filter type - "+r)}this.write(e),n.lineIndex++,n.lineIndex>=n.height?(this._lastLine=null,this._imageIndex++,n=this._images[this._imageIndex]):this._lastLine=e,n?this.read(n.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())}})),pt=ot((function(t){let e=t.exports=function(t){at.call(this);let e=[],r=this;this._filter=new ft(t,{read:this.read.bind(this),write:function(t){e.push(t)},complete:function(){r.emit("complete",Buffer.concat(e))}}),this._filter.start()};P.default.inherits(e,at)})),dt={PNG_SIGNATURE:[137,80,78,71,13,10,26,10],TYPE_IHDR:1229472850,TYPE_IEND:1229278788,TYPE_IDAT:1229209940,TYPE_PLTE:1347179589,TYPE_tRNS:1951551059,TYPE_gAMA:1732332865,COLORTYPE_GRAYSCALE:0,COLORTYPE_PALETTE:1,COLORTYPE_COLOR:2,COLORTYPE_ALPHA:4,COLORTYPE_PALETTE_COLOR:3,COLORTYPE_COLOR_ALPHA:6,COLORTYPE_TO_BPP_MAP:{0:1,2:3,3:1,4:2,6:4},GAMMA_DIVISION:1e5},_t=ot((function(t){let e=[];!function(){for(let t=0;t<256;t++){let r=t;for(let t=0;t<8;t++)1&r?r=3988292384^r>>>1:r>>>=1;e[t]=r}}();let r=t.exports=function(){this._crc=-1};r.prototype.write=function(t){for(let r=0;r<t.length;r++)this._crc=e[255&(this._crc^t[r])]^this._crc>>>8;return!0},r.prototype.crc32=function(){return-1^this._crc},r.crc32=function(t){let r=-1;for(let n=0;n<t.length;n++)r=e[255&(r^t[n])]^r>>>8;return-1^r}})),gt=ot((function(t){let e=t.exports=function(t,e){this._options=t,t.checkCRC=!1!==t.checkCRC,this._hasIHDR=!1,this._hasIEND=!1,this._emittedHeadersFinished=!1,this._palette=[],this._colorType=0,this._chunks={},this._chunks[dt.TYPE_IHDR]=this._handleIHDR.bind(this),this._chunks[dt.TYPE_IEND]=this._handleIEND.bind(this),this._chunks[dt.TYPE_IDAT]=this._handleIDAT.bind(this),this._chunks[dt.TYPE_PLTE]=this._handlePLTE.bind(this),this._chunks[dt.TYPE_tRNS]=this._handleTRNS.bind(this),this._chunks[dt.TYPE_gAMA]=this._handleGAMA.bind(this),this.read=e.read,this.error=e.error,this.metadata=e.metadata,this.gamma=e.gamma,this.transColor=e.transColor,this.palette=e.palette,this.parsed=e.parsed,this.inflateData=e.inflateData,this.finished=e.finished,this.simpleTransparency=e.simpleTransparency,this.headersFinished=e.headersFinished||function(){}};e.prototype.start=function(){this.read(dt.PNG_SIGNATURE.length,this._parseSignature.bind(this))},e.prototype._parseSignature=function(t){let e=dt.PNG_SIGNATURE;for(let r=0;r<e.length;r++)if(t[r]!==e[r])return void this.error(new Error("Invalid file signature"));this.read(8,this._parseChunkBegin.bind(this))},e.prototype._parseChunkBegin=function(t){let e=t.readUInt32BE(0),r=t.readUInt32BE(4),n="";for(let e=4;e<8;e++)n+=String.fromCharCode(t[e]);let i=Boolean(32&t[4]);if(this._hasIHDR||r===dt.TYPE_IHDR){if(this._crc=new _t,this._crc.write(Buffer.from(n)),this._chunks[r])return this._chunks[r](e);i?this.read(e+4,this._skipChunk.bind(this)):this.error(new Error("Unsupported critical chunk type "+n))}else this.error(new Error("Expected IHDR on beggining"))},e.prototype._skipChunk=function(){this.read(8,this._parseChunkBegin.bind(this))},e.prototype._handleChunkEnd=function(){this.read(4,this._parseChunkEnd.bind(this))},e.prototype._parseChunkEnd=function(t){let e=t.readInt32BE(0),r=this._crc.crc32();this._options.checkCRC&&r!==e?this.error(new Error("Crc error - "+e+" - "+r)):this._hasIEND||this.read(8,this._parseChunkBegin.bind(this))},e.prototype._handleIHDR=function(t){this.read(t,this._parseIHDR.bind(this))},e.prototype._parseIHDR=function(t){this._crc.write(t);let e=t.readUInt32BE(0),r=t.readUInt32BE(4),n=t[8],i=t[9],s=t[10],o=t[11],a=t[12];if(8!==n&&4!==n&&2!==n&&1!==n&&16!==n)return void this.error(new Error("Unsupported bit depth "+n));if(!(i in dt.COLORTYPE_TO_BPP_MAP))return void this.error(new Error("Unsupported color type"));if(0!==s)return void this.error(new Error("Unsupported compression method"));if(0!==o)return void this.error(new Error("Unsupported filter method"));if(0!==a&&1!==a)return void this.error(new Error("Unsupported interlace method"));this._colorType=i;let h=dt.COLORTYPE_TO_BPP_MAP[this._colorType];this._hasIHDR=!0,this.metadata({width:e,height:r,depth:n,interlace:Boolean(a),palette:Boolean(i&dt.COLORTYPE_PALETTE),color:Boolean(i&dt.COLORTYPE_COLOR),alpha:Boolean(i&dt.COLORTYPE_ALPHA),bpp:h,colorType:i}),this._handleChunkEnd()},e.prototype._handlePLTE=function(t){this.read(t,this._parsePLTE.bind(this))},e.prototype._parsePLTE=function(t){this._crc.write(t);let e=Math.floor(t.length/3);for(let r=0;r<e;r++)this._palette.push([t[3*r],t[3*r+1],t[3*r+2],255]);this.palette(this._palette),this._handleChunkEnd()},e.prototype._handleTRNS=function(t){this.simpleTransparency(),this.read(t,this._parseTRNS.bind(this))},e.prototype._parseTRNS=function(t){if(this._crc.write(t),this._colorType===dt.COLORTYPE_PALETTE_COLOR){if(0===this._palette.length)return void this.error(new Error("Transparency chunk must be after palette"));if(t.length>this._palette.length)return void this.error(new Error("More transparent colors than palette size"));for(let e=0;e<t.length;e++)this._palette[e][3]=t[e];this.palette(this._palette)}this._colorType===dt.COLORTYPE_GRAYSCALE&&this.transColor([t.readUInt16BE(0)]),this._colorType===dt.COLORTYPE_COLOR&&this.transColor([t.readUInt16BE(0),t.readUInt16BE(2),t.readUInt16BE(4)]),this._handleChunkEnd()},e.prototype._handleGAMA=function(t){this.read(t,this._parseGAMA.bind(this))},e.prototype._parseGAMA=function(t){this._crc.write(t),this.gamma(t.readUInt32BE(0)/dt.GAMMA_DIVISION),this._handleChunkEnd()},e.prototype._handleIDAT=function(t){this._emittedHeadersFinished||(this._emittedHeadersFinished=!0,this.headersFinished()),this.read(-t,this._parseIDAT.bind(this,t))},e.prototype._parseIDAT=function(t,e){if(this._crc.write(e),this._colorType===dt.COLORTYPE_PALETTE_COLOR&&0===this._palette.length)throw new Error("Expected palette not found");this.inflateData(e);let r=t-e.length;r>0?this._handleIDAT(r):this._handleChunkEnd()},e.prototype._handleIEND=function(t){this.read(t,this._parseIEND.bind(this))},e.prototype._parseIEND=function(t){this._crc.write(t),this._hasIEND=!0,this._handleChunkEnd(),this.finished&&this.finished()}}));let mt=[function(){},function(t,e,r,n){if(n===e.length)throw new Error("Ran out of data");let i=e[n];t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=255},function(t,e,r,n){if(n+1>=e.length)throw new Error("Ran out of data");let i=e[n];t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=e[n+1]},function(t,e,r,n){if(n+2>=e.length)throw new Error("Ran out of data");t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=255},function(t,e,r,n){if(n+3>=e.length)throw new Error("Ran out of data");t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=e[n+3]}],yt=[function(){},function(t,e,r,n){let i=e[0];t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=n},function(t,e,r){let n=e[0];t[r]=n,t[r+1]=n,t[r+2]=n,t[r+3]=e[1]},function(t,e,r,n){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=n},function(t,e,r){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2],t[r+3]=e[3]}];function bt(t,e,r,n,i,s){let o=t.width,a=t.height,h=t.index;for(let t=0;t<a;t++)for(let a=0;a<o;a++){let o=r(a,t,h);mt[n](e,i,o,s),s+=n}return s}function wt(t,e,r,n,i,s){let o=t.width,a=t.height,h=t.index;for(let t=0;t<a;t++){for(let a=0;a<o;a++){let o=i.get(n),l=r(a,t,h);yt[n](e,o,l,s)}i.resetAfterLine()}}var Et=function(t,e){let r,n,i=e.width,s=e.height,o=e.depth,a=e.bpp,h=e.interlace;8!==o&&(r=function(t,e){let r=[],n=0;function i(){if(n===t.length)throw new Error("Ran out of data");let i,s,o,a,h,l,u,c,f=t[n];switch(n++,e){default:throw new Error("unrecognised depth");case 16:u=t[n],n++,r.push((f<<8)+u);break;case 4:u=15&f,c=f>>4,r.push(c,u);break;case 2:h=3&f,l=f>>2&3,u=f>>4&3,c=f>>6&3,r.push(c,u,l,h);break;case 1:i=1&f,s=f>>1&1,o=f>>2&1,a=f>>3&1,h=f>>4&1,l=f>>5&1,u=f>>6&1,c=f>>7&1,r.push(c,u,l,h,a,o,s,i)}}return{get:function(t){for(;r.length<t;)i();let e=r.slice(0,t);return r=r.slice(t),e},resetAfterLine:function(){r.length=0},end:function(){if(n!==t.length)throw new Error("extra data found")}}}(t,o)),n=o<=8?Buffer.alloc(i*s*4):new Uint16Array(i*s*4);let l,u,c=Math.pow(2,o)-1,f=0;if(h)l=lt(i,s),u=ut(i,s);else{let t=0;u=function(){let e=t;return t+=4,e},l=[{width:i,height:s}]}for(let e=0;e<l.length;e++)8===o?f=bt(l[e],n,u,a,t,f):wt(l[e],n,u,a,r,c);if(8===o){if(f!==t.length)throw new Error("extra data found")}else r.end();return n};var vt=function(t,e,r=!1){let n=e.depth,i=e.width,s=e.height,o=e.colorType,a=e.transColor,h=e.palette,l=t;return 3===o?function(t,e,r,n,i){let s=0;for(let o=0;o<n;o++)for(let n=0;n<r;n++){let r=i[t[s]];if(!r)throw new Error("index "+t[s]+" not in palette");for(let t=0;t<4;t++)e[s+t]=r[t];s+=4}}(t,l,i,s,h):(a&&function(t,e,r,n,i){let s=0;for(let o=0;o<n;o++)for(let n=0;n<r;n++){let r=!1;if(1===i.length?i[0]===t[s]&&(r=!0):i[0]===t[s]&&i[1]===t[s+1]&&i[2]===t[s+2]&&(r=!0),r)for(let t=0;t<4;t++)e[s+t]=0;s+=4}}(t,l,i,s,a),8===n||r||(16===n&&(l=Buffer.alloc(i*s*4)),function(t,e,r,n,i){let s=Math.pow(2,i)-1,o=0;for(let i=0;i<n;i++)for(let n=0;n<r;n++){for(let r=0;r<4;r++)e[o+r]=Math.floor(255*t[o+r]/s+.5);o+=4}}(t,l,i,s,n))),l},kt=ot((function(t){let e=t.exports=function(t){at.call(this),this._parser=new gt(t,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=t,this.writable=!0,this._parser.start()};P.default.inherits(e,at),e.prototype._handleError=function(t){this.emit("error",t),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",(function(){}))),this.errord=!0},e.prototype._inflateData=function(t){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=L.default.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{let t=(1+(this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3))*this._bitmapInfo.height,e=Math.max(t,L.default.Z_MIN_CHUNK);this._inflate=L.default.createInflate({chunkSize:e});let r=t,n=this.emit.bind(this,"error");this._inflate.on("error",(function(t){r&&n(t)})),this._filter.on("complete",this._complete.bind(this));let i=this._filter.write.bind(this._filter);this._inflate.on("data",(function(t){r&&(t.length>r&&(t=t.slice(0,r)),r-=t.length,i(t))})),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(t)},e.prototype._handleMetaData=function(t){this._metaData=t,this._bitmapInfo=Object.create(t),this._filter=new pt(this._bitmapInfo)},e.prototype._handleTransColor=function(t){this._bitmapInfo.transColor=t},e.prototype._handlePalette=function(t){this._bitmapInfo.palette=t},e.prototype._simpleTransparency=function(){this._metaData.alpha=!0},e.prototype._headersFinished=function(){this.emit("metadata",this._metaData)},e.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"))},e.prototype._complete=function(t){if(this.errord)return;let e;try{let r=Et(t,this._bitmapInfo);e=vt(r,this._bitmapInfo,this._options.skipRescale),r=null}catch(t){return void this._handleError(t)}this.emit("parsed",e)}}));let Tt={0:function(t,e,r,n,i){for(let s=0;s<r;s++)n[i+s]=t[e+s]},1:function(t,e,r,n,i,s){for(let o=0;o<r;o++){let r=o>=s?t[e+o-s]:0,a=t[e+o]-r;n[i+o]=a}},2:function(t,e,r,n,i){for(let s=0;s<r;s++){let o=e>0?t[e+s-r]:0,a=t[e+s]-o;n[i+s]=a}},3:function(t,e,r,n,i,s){for(let o=0;o<r;o++){let a=o>=s?t[e+o-s]:0,h=e>0?t[e+o-r]:0,l=t[e+o]-(a+h>>1);n[i+o]=l}},4:function(t,e,r,n,i,s){for(let o=0;o<r;o++){let a=o>=s?t[e+o-s]:0,h=e>0?t[e+o-r]:0,l=e>0&&o>=s?t[e+o-(r+s)]:0,u=t[e+o]-ct(a,h,l);n[i+o]=u}}},Ot={0:function(t,e,r){let n=0,i=e+r;for(let r=e;r<i;r++)n+=Math.abs(t[r]);return n},1:function(t,e,r,n){let i=0;for(let s=0;s<r;s++){let r=s>=n?t[e+s-n]:0,o=t[e+s]-r;i+=Math.abs(o)}return i},2:function(t,e,r){let n=0,i=e+r;for(let s=e;s<i;s++){let i=e>0?t[s-r]:0,o=t[s]-i;n+=Math.abs(o)}return n},3:function(t,e,r,n){let i=0;for(let s=0;s<r;s++){let o=s>=n?t[e+s-n]:0,a=e>0?t[e+s-r]:0,h=t[e+s]-(o+a>>1);i+=Math.abs(h)}return i},4:function(t,e,r,n){let i=0;for(let s=0;s<r;s++){let o=s>=n?t[e+s-n]:0,a=e>0?t[e+s-r]:0,h=e>0&&s>=n?t[e+s-(r+n)]:0,l=t[e+s]-ct(o,a,h);i+=Math.abs(l)}return i}};var xt=ot((function(t){let e=t.exports=function(t){if(this._options=t,t.deflateChunkSize=t.deflateChunkSize||32768,t.deflateLevel=null!=t.deflateLevel?t.deflateLevel:9,t.deflateStrategy=null!=t.deflateStrategy?t.deflateStrategy:3,t.inputHasAlpha=null==t.inputHasAlpha||t.inputHasAlpha,t.deflateFactory=t.deflateFactory||L.default.createDeflate,t.bitDepth=t.bitDepth||8,t.colorType="number"==typeof t.colorType?t.colorType:dt.COLORTYPE_COLOR_ALPHA,t.inputColorType="number"==typeof t.inputColorType?t.inputColorType:dt.COLORTYPE_COLOR_ALPHA,-1===[dt.COLORTYPE_GRAYSCALE,dt.COLORTYPE_COLOR,dt.COLORTYPE_COLOR_ALPHA,dt.COLORTYPE_ALPHA].indexOf(t.colorType))throw new Error("option color type:"+t.colorType+" is not supported at present");if(-1===[dt.COLORTYPE_GRAYSCALE,dt.COLORTYPE_COLOR,dt.COLORTYPE_COLOR_ALPHA,dt.COLORTYPE_ALPHA].indexOf(t.inputColorType))throw new Error("option input color type:"+t.inputColorType+" is not supported at present");if(8!==t.bitDepth&&16!==t.bitDepth)throw new Error("option bit depth:"+t.bitDepth+" is not supported at present")};e.prototype.getDeflateOptions=function(){return{chunkSize:this._options.deflateChunkSize,level:this._options.deflateLevel,strategy:this._options.deflateStrategy}},e.prototype.createDeflate=function(){return this._options.deflateFactory(this.getDeflateOptions())},e.prototype.filterData=function(t,e,r){let n=function(t,e,r,n){let i=-1!==[dt.COLORTYPE_COLOR_ALPHA,dt.COLORTYPE_ALPHA].indexOf(n.colorType);if(n.colorType===n.inputColorType){let e=function(){let t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256!==new Int16Array(t)[0]}();if(8===n.bitDepth||16===n.bitDepth&&e)return t}let s=16!==n.bitDepth?t:new Uint16Array(t.buffer),o=255,a=dt.COLORTYPE_TO_BPP_MAP[n.inputColorType];4!==a||n.inputHasAlpha||(a=3);let h=dt.COLORTYPE_TO_BPP_MAP[n.colorType];16===n.bitDepth&&(o=65535,h*=2);let l=Buffer.alloc(e*r*h),u=0,c=0,f=n.bgColor||{};function p(){let t,e,r,a=o;switch(n.inputColorType){case dt.COLORTYPE_COLOR_ALPHA:a=s[u+3],t=s[u],e=s[u+1],r=s[u+2];break;case dt.COLORTYPE_COLOR:t=s[u],e=s[u+1],r=s[u+2];break;case dt.COLORTYPE_ALPHA:a=s[u+1],t=s[u],e=t,r=t;break;case dt.COLORTYPE_GRAYSCALE:t=s[u],e=t,r=t;break;default:throw new Error("input color type:"+n.inputColorType+" is not supported at present")}return n.inputHasAlpha&&(i||(a/=o,t=Math.min(Math.max(Math.round((1-a)*f.red+a*t),0),o),e=Math.min(Math.max(Math.round((1-a)*f.green+a*e),0),o),r=Math.min(Math.max(Math.round((1-a)*f.blue+a*r),0),o))),{red:t,green:e,blue:r,alpha:a}}void 0===f.red&&(f.red=o),void 0===f.green&&(f.green=o),void 0===f.blue&&(f.blue=o);for(let t=0;t<r;t++)for(let t=0;t<e;t++){let t=p();switch(n.colorType){case dt.COLORTYPE_COLOR_ALPHA:case dt.COLORTYPE_COLOR:8===n.bitDepth?(l[c]=t.red,l[c+1]=t.green,l[c+2]=t.blue,i&&(l[c+3]=t.alpha)):(l.writeUInt16BE(t.red,c),l.writeUInt16BE(t.green,c+2),l.writeUInt16BE(t.blue,c+4),i&&l.writeUInt16BE(t.alpha,c+6));break;case dt.COLORTYPE_ALPHA:case dt.COLORTYPE_GRAYSCALE:{let e=(t.red+t.green+t.blue)/3;8===n.bitDepth?(l[c]=e,i&&(l[c+1]=t.alpha)):(l.writeUInt16BE(e,c),i&&l.writeUInt16BE(t.alpha,c+2));break}default:throw new Error("unrecognised color Type "+n.colorType)}u+=a,c+=h}return l}(t,e,r,this._options),i=dt.COLORTYPE_TO_BPP_MAP[this._options.colorType];return function(t,e,r,n,i){let s;if("filterType"in n&&-1!==n.filterType){if("number"!=typeof n.filterType)throw new Error("unrecognised filter types");s=[n.filterType]}else s=[0,1,2,3,4];16===n.bitDepth&&(i*=2);let o=e*i,a=0,h=0,l=Buffer.alloc((o+1)*r),u=s[0];for(let e=0;e<r;e++){if(s.length>1){let e=1/0;for(let r=0;r<s.length;r++){let n=Ot[s[r]](t,h,o,i);n<e&&(u=s[r],e=n)}}l[a]=u,a++,Tt[u](t,h,o,l,a,i),a+=o,h+=o}return l}(n,e,r,this._options,i)},e.prototype._packChunk=function(t,e){let r=e?e.length:0,n=Buffer.alloc(r+12);return n.writeUInt32BE(r,0),n.writeUInt32BE(t,4),e&&e.copy(n,8),n.writeInt32BE(_t.crc32(n.slice(4,n.length-4)),n.length-4),n},e.prototype.packGAMA=function(t){let e=Buffer.alloc(4);return e.writeUInt32BE(Math.floor(t*dt.GAMMA_DIVISION),0),this._packChunk(dt.TYPE_gAMA,e)},e.prototype.packIHDR=function(t,e){let r=Buffer.alloc(13);return r.writeUInt32BE(t,0),r.writeUInt32BE(e,4),r[8]=this._options.bitDepth,r[9]=this._options.colorType,r[10]=0,r[11]=0,r[12]=0,this._packChunk(dt.TYPE_IHDR,r)},e.prototype.packIDAT=function(t){return this._packChunk(dt.TYPE_IDAT,t)},e.prototype.packIEND=function(){return this._packChunk(dt.TYPE_IEND,null)}})),Rt=ot((function(t){let e=t.exports=function(t){I.default.call(this);let e=t||{};this._packer=new xt(e),this._deflate=this._packer.createDeflate(),this.readable=!0};P.default.inherits(e,I.default),e.prototype.pack=function(t,e,r,n){this.emit("data",Buffer.from(dt.PNG_SIGNATURE)),this.emit("data",this._packer.packIHDR(e,r)),n&&this.emit("data",this._packer.packGAMA(n));let i=this._packer.filterData(t,e,r);this._deflate.on("error",this.emit.bind(this,"error")),this._deflate.on("data",function(t){this.emit("data",this._packer.packIDAT(t))}.bind(this)),this._deflate.on("end",function(){this.emit("data",this._packer.packIEND()),this.emit("end")}.bind(this)),this._deflate.end(i)}})),Ct=ot((function(t,e){let r=A.default.ok,n=D.default.kMaxLength;function i(t){if(!(this instanceof i))return new i(t);t&&t.chunkSize<L.default.Z_MIN_CHUNK&&(t.chunkSize=L.default.Z_MIN_CHUNK),L.default.Inflate.call(this,t),this._offset=void 0===this._offset?this._outOffset:this._offset,this._buffer=this._buffer||this._outBuffer,t&&null!=t.maxLength&&(this._maxLength=t.maxLength)}function s(t,e){e&&process.nextTick(e),t._handle&&(t._handle.close(),t._handle=null)}function o(t,e){return function(t,e){if("string"==typeof e&&(e=Buffer.from(e)),!(e instanceof Buffer))throw new TypeError("Not a string or buffer");let r=t._finishFlushFlag;return null==r&&(r=L.default.Z_FINISH),t._processChunk(e,r)}(new i(e),t)}i.prototype._processChunk=function(t,e,i){if("function"==typeof i)return L.default.Inflate._processChunk.call(this,t,e,i);let o,a,h=this,l=t&&t.length,u=this._chunkSize-this._offset,c=this._maxLength,f=0,p=[],d=0;function _(t,e){if(h._hadError)return;let n=u-e;if(r(n>=0,"have should not go down"),n>0){let t=h._buffer.slice(h._offset,h._offset+n);if(h._offset+=n,t.length>c&&(t=t.slice(0,c)),p.push(t),d+=t.length,c-=t.length,0===c)return!1}return(0===e||h._offset>=h._chunkSize)&&(u=h._chunkSize,h._offset=0,h._buffer=Buffer.allocUnsafe(h._chunkSize)),0===e&&(f+=l-t,l=t,!0)}this.on("error",(function(t){o=t})),r(this._handle,"zlib binding closed");do{a=this._handle.writeSync(e,t,f,l,this._buffer,this._offset,u),a=a||this._writeState}while(!this._hadError&&_(a[0],a[1]));if(this._hadError)throw o;if(d>=n)throw s(this),new RangeError("Cannot create final Buffer. It would be larger than 0x"+n.toString(16)+" bytes");let g=Buffer.concat(p,d);return s(this),g},P.default.inherits(i,L.default.Inflate),t.exports=e=o,e.Inflate=i,e.createInflate=function(t){return new i(t)},e.inflateSync=o}));Ct.Inflate,Ct.createInflate,Ct.inflateSync;var Pt=ot((function(t){let e=t.exports=function(t){this._buffer=t,this._reads=[]};e.prototype.read=function(t,e){this._reads.push({length:Math.abs(t),allowLess:t<0,func:e})},e.prototype.process=function(){for(;this._reads.length>0&&this._buffer.length;){let t=this._reads[0];if(!this._buffer.length||!(this._buffer.length>=t.length||t.allowLess))break;{this._reads.shift();let e=this._buffer;this._buffer=e.slice(t.length),t.func.call(this,e.slice(0,t.length))}}if(this._reads.length>0)throw new Error("There are some read requests waitng on finished stream");if(this._buffer.length>0)throw new Error("unrecognised content at end of stream")}})),It=function(t,e){let r=[],n=new Pt(t);return new ft(e,{read:n.read.bind(n),write:function(t){r.push(t)},complete:function(){}}).start(),n.process(),Buffer.concat(r)};let Lt=!0;L.default.deflateSync||(Lt=!1);let At=!0;L.default.deflateSync||(At=!1);var Dt={read:function(t,e){return function(t,e){if(!Lt)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let r,n,i,s=[],o=new Pt(t);if(new gt(e,{read:o.read.bind(o),error:function(t){r=t},metadata:function(t){n=t},gamma:function(t){i=t},palette:function(t){n.palette=t},transColor:function(t){n.transColor=t},inflateData:function(t){s.push(t)},simpleTransparency:function(){n.alpha=!0}}).start(),o.process(),r)throw r;let a,h=Buffer.concat(s);if(s.length=0,n.interlace)a=L.default.inflateSync(h);else{let t=(1+(n.width*n.bpp*n.depth+7>>3))*n.height;a=Ct(h,{chunkSize:t,maxLength:t})}if(h=null,!a||!a.length)throw new Error("bad png - invalid inflate data response");let l=It(a,n);h=null;let u=Et(l,n);l=null;let c=vt(u,n,e.skipRescale);return n.data=c,n.gamma=i||0,n}(t,e||{})},write:function(t,e){return function(t,e){if(!At)throw new Error("To use the sync capability of this library in old node versions, please pin pngjs to v2.3.0");let r=new xt(e||{}),n=[];n.push(Buffer.from(dt.PNG_SIGNATURE)),n.push(r.packIHDR(t.width,t.height)),t.gamma&&n.push(r.packGAMA(t.gamma));let i=r.filterData(t.data,t.width,t.height),s=L.default.deflateSync(i,r.getDeflateOptions());if(i=null,!s||!s.length)throw new Error("bad png - invalid compressed data response");return n.push(r.packIDAT(s)),n.push(r.packIEND()),Buffer.concat(n)}(t,e)}},St=ot((function(t,e){let r=e.PNG=function(t){I.default.call(this),t=t||{},this.width=0|t.width,this.height=0|t.height,this.data=this.width>0&&this.height>0?Buffer.alloc(4*this.width*this.height):null,t.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new kt(t),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(t){this.data=t,this.emit("parsed",t)}.bind(this)),this._packer=new Rt(t),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};P.default.inherits(r,I.default),r.sync=Dt,r.prototype.pack=function(){return this.data&&this.data.length?(process.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this):(this.emit("error","No data provided"),this)},r.prototype.parse=function(t,e){if(e){let t,r;t=function(t){this.removeListener("error",r),this.data=t,e(null,this)}.bind(this),r=function(r){this.removeListener("parsed",t),e(r,null)}.bind(this),this.once("parsed",t),this.once("error",r)}return this.end(t),this},r.prototype.write=function(t){return this._parser.write(t),!0},r.prototype.end=function(t){this._parser.end(t)},r.prototype._metadata=function(t){this.width=t.width,this.height=t.height,this.emit("metadata",t)},r.prototype._gamma=function(t){this.gamma=t},r.prototype._handleClose=function(){this._parser.writable||this._packer.readable||this.emit("close")},r.bitblt=function(t,e,r,n,i,s,o,a){if(n|=0,i|=0,s|=0,o|=0,a|=0,(r|=0)>t.width||n>t.height||r+i>t.width||n+s>t.height)throw new Error("bitblt reading outside image");if(o>e.width||a>e.height||o+i>e.width||a+s>e.height)throw new Error("bitblt writing outside image");for(let h=0;h<s;h++)t.data.copy(e.data,(a+h)*e.width+o<<2,(n+h)*t.width+r<<2,(n+h)*t.width+r+i<<2)},r.prototype.bitblt=function(t,e,n,i,s,o,a){return r.bitblt(this,t,e,n,i,s,o,a),this},r.adjustGamma=function(t){if(t.gamma){for(let e=0;e<t.height;e++)for(let r=0;r<t.width;r++){let n=t.width*e+r<<2;for(let e=0;e<3;e++){let r=t.data[n+e]/255;r=Math.pow(r,1/2.2/t.gamma),t.data[n+e]=Math.round(255*r)}}t.gamma=0}},r.prototype.adjustGamma=function(){r.adjustGamma(this)}})).PNG,Yt=function(t,e,r){var n=r.value;r.value=M(regeneratorRuntime.mark((function t(){var e,r,i,s=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.ppt){t.next=5;break}for(e=s.length,r=new Array(e),i=0;i<e;i++)r[i]=s[i];return t.next=4,n.apply(this,r);case 4:return t.abrupt("return",t.sent);case 5:console.warn("Require koishi-plugin-puppeteer, but not install.");case 6:case"end":return t.stop()}}),t,this)})))},Mt=function(){function t(){B(this,t),this.images=[],this.stream={url:""},this.async$=this.asyncSelect,this.$=this.select}var e,r,n,i,s,a;return U(t,[{key:"ppt",get:function(){return this.ctx.puppeteer}},{key:"cfg",get:function(){return this.ppt.config}},{key:"initCTX",value:function(t){this.ctx=t}},{key:"asyncOpen",value:(a=M(regeneratorRuntime.mark((function t(e){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.ppt.launch();case 2:return t.next=4,this.ppt.browser.newPage();case 4:return this.curPage=t.sent,this.curShooter=this.curPage,t.next=8,this.curPage.goto(e);case 8:return t.abrupt("return",this);case 9:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"open",value:function(t){return this.stream.url=t,this}},{key:"asyncSelect",value:(s=M(regeneratorRuntime.mark((function t(e){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.curPage.$(e);case 2:return this.curShooter=t.sent,t.abrupt("return",this);case 4:case"end":return t.stop()}}),t,this)}))),function(t){return s.apply(this,arguments)})},{key:"select",value:function(t){return this.stream.selector=t,this}},{key:"asyncViewport",value:(i=M(regeneratorRuntime.mark((function t(e){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.curPage.setViewport(j(j(j({},this.cfg.browser.defaultViewport),this.cfg.renderViewport),e));case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"viewport",value:function(t){return this.stream.viewport=t,this}},{key:"asyncShot",value:(n=M(regeneratorRuntime.mark((function t(){var e,r,n=this,i=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=i.length>0&&void 0!==i[0]?i[0]:{},t.next=3,this.curShooter.screenshot(j({encoding:"binary"},e));case 3:if(!((r=t.sent).byteLength>this.cfg.maxLength)){t.next=7;break}return t.next=7,new Promise((function(t,e){(new St).parse(r,(function(r,n){return r?e(r):t(n)}))})).then((function(t){var e=t.width,i=t.height*n.cfg.maxLength/r.byteLength,s=new St({width:e,height:i});t.bitblt(s,0,0,e,i,0,0),r=St.sync.write(s)})).catch(console.error);case 7:return this.images.push(o.segment.image(r)),t.abrupt("return",this);case 9:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"shot",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.stream.option=t,this}},{key:"asyncClose",value:(r=M(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.ppt.close();case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"start",value:(e=M(regeneratorRuntime.mark((function t(){var e,r,n,i,s;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.stream,r=e.url,n=e.selector,i=e.viewport,s=e.option,t.t0=r,!t.t0){t.next=5;break}return t.next=5,this.asyncOpen(r);case 5:if(t.t1=n,!t.t1){t.next=9;break}return t.next=9,this.async$(n);case 9:if(t.t2=i,!t.t2){t.next=13;break}return t.next=13,this.asyncViewport(i);case 13:if(t.t3=s,!t.t3){t.next=17;break}return t.next=17,this.asyncShot(s);case 17:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})}]),t}();st([Yt],Mt.prototype,"asyncOpen",null),st([Yt],Mt.prototype,"asyncSelect",null),st([Yt],Mt.prototype,"asyncViewport",null),st([Yt],Mt.prototype,"asyncShot",null),st([Yt],Mt.prototype,"asyncClose",null);var Bt=new Mt;n.User.extend((function(){return{todos:[]}}));var Nt=function(){var t=M(regeneratorRuntime.mark((function t(e,r){var n,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.database.getUser("onebot",null!==(n=null==r||null===(i=r.author)||void 0===i?void 0:i.userId)&&void 0!==n?n:""));case 1:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}(),Ut=function(t,e){var r=t.todos.filter((function(t){return new RegExp(e).test(t.id)}))[0];if(void 0===r)throw new Error("todoä¸å­˜åœ¨");return r},qt=function(t){var e,r,n,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=i?t.id.slice(0,10):t.id,o=t.tags.length>0?"[".concat(t.tags.join(", "),"]"):"";return"[".concat(v.default(t.ctime).format("YYYY-MM-DD HH:mm:ss"),"][").concat(s,"]").concat(o,"\n")+"æ ‡é¢˜: ".concat(t.name,"\n")+"ä»‹ç»: ".concat(null!==(e=null==t?void 0:t.desc)&&void 0!==e?e:"æœªæè¿°å†…å®¹","\n")+"æŒ‡æ´¾äºº: ".concat(null!==(r=null===(n=t.designator)||void 0===n?void 0:n.qq)&&void 0!==r?r:"æ— æŒ‡æ´¾äºº","\n")+"================================= (".concat(t.status,")\n")},Ht=function(t){return"å…±".concat(t.length,"ğŸ“ï¼Œ")+"âå¾…å®Œæˆ".concat(t.filter((function(t){return"processing"===t.status})).length,"ï¼Œ")+"âœ…å·²å®Œæˆ".concat(t.filter((function(t){return"finished"===t.status})).length,"\n")},jt=function(t,e,r){return t=t.filter((function(t){return void 0===e||"all"===e||t.tags.length>0&&-1!==t.tags.indexOf(e)})),null!=r&&r.week&&!r.mouth&&(t=t.filter((function(t){return!v.default(t.ctime).isBefore(v.default().add(-7,"day"))}))),null!=r&&r.mouth&&(t=t.filter((function(t){return!v.default(t.ctime).isBefore(v.default().add(-30,"day"))}))),t},Gt=function(t,e){(t=>{const e=t.app.router;e.use((async(t,e)=>{if(!/^\/work\/.*/.test(t.path))return await e();{let r=await e();r.$$typeof===Symbol.for("react.element")&&(r=a.renderToString(r),t.body=`\n          <head>\n            <title></title>\n            ${rt.renderStyles()}\n          </head>\n          ${r}\n        `,rt.clearStyle())}})),e.get("/work/:qqNum/todos/:tag",(async(e,r)=>{const n=await et(t,`onebot:${parseInt(e.params.qqNum)}`),i=jt(n.todos,e.params.tag,e.query);return rt.defaultStyles={label:[__dirname,"../static/label.scss"],element:[__dirname,"../static/element.scss"],"github-md":[__dirname,"../static/github-markdown.scss"]},T.createElement("body",{style:{width:"800px"}},T.createElement(it,{todos:i}))}))})(t);var r=e.subcommand(".todos",{authority:1}).alias("todos");r.subcommand(".add <name> [desc:text]").usage("æ·»åŠ todoåˆ°ä»£åŠåˆ—è¡¨").option("tag","-t [tag] æ ‡ç­¾").option("isGroup","-g æŒ‡å®šåˆ°å½“å‰ç¾¤ç»„",{type:"boolean"}).option("user","-u [user:user] æŒ‡å®šç”¨æˆ·",{authority:3}).action(function(){var e=M(regeneratorRuntime.mark((function e(r,n,i){var s,o,a,h,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.session,o=r.options,void 0!==n&&""!==n){e.next=3;break}return e.abrupt("return","å‚æ•°é”™è¯¯");case 3:if(!s){e.next=20;break}return e.next=6,Nt(t,s);case 6:if(a=e.sent,null==o||!o.user){e.next=13;break}return e.next=10,et(t,o.user);case 10:h=e.sent,e.next=14;break;case 13:h=a;case 14:return l={id:Q(),name:n,desc:i,tags:null!=o&&o.tag?[null==o?void 0:o.tag]:[],status:"processing",designator:{qq:a.onebot},ctime:new Date},h.todos||(h.todos=[]),h.todos.push(l),e.next=19,t.database.setUser("onebot",h.onebot,h);case 19:return e.abrupt("return","[".concat(n,"ğŸ“todo] æ·»åŠ æˆåŠŸ\n")+Ht(h.todos)+"ğŸ“.id: ".concat(l.id));case 20:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),r.subcommand(".list [tag]").usage("å±•ç¤ºå·²æœ‰çš„todoï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè®¾ç½®çš„æ ‡ç­¾").option("week","-w å±•ç¤ºè¿‘ä¸€å‘¨",{type:"boolean"}).option("mouth","-m å±•ç¤ºè¿‘ä¸€ä¸ªæœˆ",{type:"boolean"}).option("picture","-p ä»¥å›¾ç‰‡çš„å½¢å¼å±•ç¤º",{type:"boolean"}).option("isGroup","-g æŒ‡å®šåˆ°å½“å‰ç¾¤ç»„",{type:"boolean"}).option("long","-l é•¿ä¿¡æ¯",{type:"boolean"}).option("user","-u [user:user] æŒ‡å®šç”¨æˆ·",{authority:3}).action(function(){var e=M(regeneratorRuntime.mark((function e(r,n){var i,s,o,a,h,l,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.session,s=r.options,!i){e.next=21;break}return e.next=4,Nt(t,i);case 4:if(o=e.sent,null==s||!s.user){e.next=11;break}return e.next=8,et(t,s.user);case 8:a=e.sent,e.next=12;break;case 11:a=o;case 12:if(!s.picture){e.next=19;break}return h="http://localhost:13333/work/".concat(a.onebot,"/todos/").concat(null!=n?n:"all","?").concat(k.stringify(s)),e.next=16,Bt.open(h).$("body").shot().start();case 16:return l=Bt.images[0],Bt.images=[],e.abrupt("return",l);case 19:return u=jt(a.todos,n,s),e.abrupt("return",Ht(u)+u.map((function(t){return qt(t,!(null!=s&&s.long))})).join("\n"));case 21:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()),r.subcommand(".update <id> [status]").usage("æ›´æ–°å·²æœ‰çš„todoä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtodoçš„idï¼Œå¯ç®€å†™ä½†å¿…é¡»å”¯ä¸€ã€‚").option("tag","-t [tag] æ ‡ç­¾").option("desc","-d [desc:text] ä»‹ç»").action(function(){var e=M(regeneratorRuntime.mark((function e(r,n,i){var s,o,a,h,l,u,c,f,p,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.session,o=r.options,!(void 0===n||""===n||i&&-1===["processing","finished"].indexOf(i))){e.next=3;break}return e.abrupt("return","å‚æ•°é”™è¯¯");case 3:if(!s){e.next=22;break}return e.prev=4,e.next=7,Nt(t,s);case 7:return c=e.sent,f=Ut(c,n),i&&(f.status=i),(null==o?void 0:o.tag)&&f.tags.push(null==o?void 0:o.tag),o.desc&&(f.desc=null==o?void 0:o.desc),e.next=14,t.database.setUser("onebot",null!==(a=null==s||null===(h=s.author)||void 0===h?void 0:h.userId)&&void 0!==a?a:"",c);case 14:if(null===(l=f.designator)||void 0===l||!l.qq||(null===(u=f.designator)||void 0===u?void 0:u.qq)===c.onebot||"finished"!==i){e.next=16;break}return e.abrupt("return","".concat(tt.at(null!==(p=null===(d=f.designator)||void 0===d?void 0:d.qq)&&void 0!==p?p:""),"\n").concat(qt(f)));case 16:return e.abrupt("return",qt(f));case 19:return e.prev=19,e.t0=e.catch(4),e.abrupt("return",e.t0.message);case 22:case"end":return e.stop()}}),e,null,[[4,19]])})));return function(t,r,n){return e.apply(this,arguments)}}()),r.subcommand(".get <id>").usage("è·å–æŒ‡å®šçš„todoä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtodoçš„idï¼Œå¯ç®€å†™ä½†å¿…é¡»å”¯ä¸€ã€‚").check((function(t,e){if(void 0===e||""===e)return"å‚æ•°é”™è¯¯"})).action(function(){var e=M(regeneratorRuntime.mark((function e(r,n){var i,s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=r.session)){e.next=13;break}return e.prev=2,e.next=5,Nt(t,i);case 5:return s=e.sent,o=Ut(s,n),e.abrupt("return",qt(o));case 10:return e.prev=10,e.t0=e.catch(2),e.abrupt("return",e.t0.message);case 13:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(t,r){return e.apply(this,arguments)}}()),r.subcommand(".del <id>").usage("åˆ é™¤æŒ‡å®šçš„todoä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtodoçš„idï¼Œå¯ç®€å†™ä½†å¿…é¡»å”¯ä¸€ã€‚").action(function(){var e=M(regeneratorRuntime.mark((function e(r,n){var i,s,o,a,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.session,void 0!==n&&""!==n){e.next=3;break}return e.abrupt("return","å‚æ•°é”™è¯¯");case 3:if(!i){e.next=20;break}return e.prev=4,e.next=7,Nt(t,i);case 7:if(a=e.sent,-1!==(h=a.todos.findIndex((function(t){return new RegExp("^".concat(n)).test(t.id)})))){e.next=11;break}return e.abrupt("return","æœªæ£€ç´¢åˆ°æŒ‡å®štodoï¼Œè¯·æ£€æŸ¥æ˜¯å¦å­˜åœ¨");case 11:return a.todos.splice(h,1),e.next=14,t.database.setUser("onebot",null!==(s=null==i||null===(o=i.author)||void 0===o?void 0:o.userId)&&void 0!==s?s:"",a);case 14:return e.abrupt("return","åˆ é™¤todoæˆåŠŸ\n"+Ht(a.todos));case 17:return e.prev=17,e.t0=e.catch(4),e.abrupt("return",e.t0.message);case 20:case"end":return e.stop()}}),e,null,[[4,17]])})));return function(t,r){return e.apply(this,arguments)}}()),r.subcommand(".clear <tag>").usage("åˆ é™¤æŒ‡å®štagçš„todoä¿¡æ¯ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtodoçš„tagã€‚").action(function(){var e=M(regeneratorRuntime.mark((function e(r,n){var i,s,o,a,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.session,void 0!==n&&""!==n){e.next=3;break}return e.abrupt("return","å‚æ•°é”™è¯¯");case 3:if(!i){e.next=18;break}return e.prev=4,e.next=7,Nt(t,i);case 7:a=e.sent,h=0;do{h=a.todos.findIndex((function(t){return-1!==t.tags.indexOf(n)}))-1,a.todos.splice(h,1)}while(-1!==h);return e.next=12,t.database.setUser("onebot",null!==(s=null==i||null===(o=i.author)||void 0===o?void 0:o.userId)&&void 0!==s?s:"",a);case 12:return e.abrupt("return","åˆ é™¤todo(".concat(n,")æˆåŠŸ"));case 15:return e.prev=15,e.t0=e.catch(4),e.abrupt("return",e.t0.message);case 18:case"end":return e.stop()}}),e,null,[[4,15]])})));return function(t,r){return e.apply(this,arguments)}}())};t.apply=function(t,e){t.logger("koishi-plugin-work"),t.with(["koishi-plugin-puppeteer"],(function(){Bt.initCTX(t)}));var r=t.command("work",{authority:1});Gt(t,r)},t.name="work",Object.defineProperty(t,"__esModule",{value:!0})}));
